##
# gocd stack
##
# This file is a Jinja2 template
# Which means you can use variables defined in group_vars here
# @see https://docs.ansible.com/ansible/latest/user_guide/playbooks_templating.html
##
version: "3.7"

networks:
  traefik:
    driver: overlay
    external: true
 
services:
  # GOCD
  # Master to be deployed in Swarm manager node
  gocd-server:
    image: gocd/gocd-server:v19.11.0
    ports:
      - "8153:8153"
    networks:
      - traefik
    deploy:
      labels: 
        - traefik.frontend.rule=PathPrefixStrip:/devops/gocd
        - traefik.enable=true
        - traefik.port=8153
        - traefik.docker.network=traefik
        # Traefik service that listens to HTTP
        - traefik.redirectorservice.frontend.entryPoints=http
{% if traefik_https %} # you can also use conditional statements       
        - traefik.redirectorservice.frontend.redirect.entryPoint=https
        # Traefik service that listens to HTTPS
        - traefik.webservice.frontend.entryPoints=https   
{% endif %} 
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: '0.80'
          memory: 1024M
        reservations:
          cpus: '0.10'
          memory: 20M
  go-agent:
    image: gocd/gocd-agent-ubuntu-16.04:v19.11.0
    environment:
      GO_SERVER_URL: https://gocd-server:8154/go
    networks:
      - traefik
    volumes: 
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      mode: replicated
      placement:
        constraints:
          - node.role == manager
      replicas: 1
      resources:
        limits:
          cpus: '0.80'
          memory: 1024M
